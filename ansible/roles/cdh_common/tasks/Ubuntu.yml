---
- name: set Cloudera on apt repository
  template: src=cloudera.list.j2 dest=/etc/apt/sources.list.d/cloudera.list owner=root group=root mode=0644

- name: additional step for trusty
  template: src=cloudera.pref.j2 dest=/etc/apt/preferences.d/cloudera.pref owner=root group=root mode=0644
  when: ansible_distribution_release == "trusty"

# optional
- name: add the Cloudera Repository Key
  apt_key: state=present url=https://archive.cloudera.com/cdh5/ubuntu/{{ ansible_distribution_release }}/amd64/cdh/archive.key

- name: apt-get update
  command: apt-get update

- name: install hadoop pseudo yarn
  apt: name=hadoop-conf-pseudo state=present

- name: check the files on Ubuntu systems
  command: dpkg -L hadoop-conf-pseudo

- name: copy /etc/hadoop/conf.pseudo to /etc/hadoop/conf.mycluster
  command: cp -R -p /etc/hadoop/conf.pseudo /etc/hadoop/conf.mycluster creates=/etc/hadoop/conf.mycluster

- name: configure Hadoop in /etc/hadoop/conf.mycluster
  template: src={{ item }}.j2 dest=/etc/hadoop/conf.mycluster/{{ item }} owner=root group=root mode=0644
  with_items:
    - core-site.xml
    - hdfs-site.xml
    - mapred-site.xml
    - yarn-site.xml
    - hadoop-env.sh
    - topology.data

- name: put topology.sh in /etc/hadoop/conf.mycluster (it must be executable)
  template: src={{ item }}.j2 dest=/etc/hadoop/conf.mycluster/{{ item }} owner=root group=root mode=0755
  with_items:
    - topology.sh

- name: run update-alternatives to install hadoop configuration
  command: update-alternatives --install /etc/hadoop/conf hadoop-conf /etc/hadoop/conf.mycluster 50

- name: run update-alternatives to set hadoop configuration
  command: update-alternatives --set hadoop-conf /etc/hadoop/conf.mycluster
